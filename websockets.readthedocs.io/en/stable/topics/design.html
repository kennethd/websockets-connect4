<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Design (legacy asyncio)" />
<meta property="og:type" content="website" />
<meta property="og:url" content="topics/design.html" />
<meta property="og:site_name" content="websockets" />
<meta property="og:description" content="This document describes the design of the legacy implementation of websockets. It assumes familiarity with the specification of the WebSocket protocol in RFC 6455. It’s primarily intended at mainta..." />
<meta name="description" content="This document describes the design of the legacy implementation of websockets. It assumes familiarity with the specification of the WebSocket protocol in RFC 6455. It’s primarily intended at mainta..." />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>Design (legacy asyncio) - websockets 14.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css%3Fv=a746c00c.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css%3Fv=354aac6f.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css%3Fv=76b2166b.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css%3Fv=4c969af8.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css%3Fv=302659d7.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #306998;
  --color-brand-content: #0b487a;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #ffd43bcc;
  --color-brand-content: #ffd43bd9;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #ffd43bcc;
  --color-brand-content: #ffd43bd9;
  
      }
    }
  }
</style><script async type="text/javascript" src="../../../_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="websockets" /><meta name="readthedocs-version-slug" content="stable" /><meta name="readthedocs-resolver-filename" content="/topics/design.html" /><meta name="readthedocs-http-status" content="200" /></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="design.html#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">websockets 14.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/websockets.svg" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../intro/index.html">Getting started</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Getting started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/tutorial1.html">Part 1 - Send &amp; receive</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/tutorial2.html">Part 2 - Route &amp; broadcast</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/tutorial3.html">Part 3 - Deploy to the web</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../howto/index.html">How-to guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of How-to guides</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../howto/quickstart.html">Quick start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/upgrade.html">Upgrade to the new <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code> implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/cheatsheet.html">Cheat sheet</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/patterns.html">Patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/autoreload.html">Reload on code changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/django.html">Integrate with Django</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/extensions.html">Write an extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/render.html">Deploy to Render</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/fly.html">Deploy to Fly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/heroku.html">Deploy to Heroku</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/kubernetes.html">Deploy to Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/supervisor.html">Deploy with Supervisor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/nginx.html">Deploy behind nginx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/haproxy.html">Deploy behind HAProxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/sansio.html">Integrate the Sans-I/O layer</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../faq/index.html">Frequently asked questions</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Frequently asked questions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/server.html">Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/client.html">Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/common.html">Both sides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/asyncio.html">Using asyncio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/features.html">Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/asyncio/server.html">Server (new <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/asyncio/client.html">Client (new <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sync/server.html">Server (<code class="xref py py-mod docutils literal notranslate"><span class="pre">threading</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sync/client.html">Client (<code class="xref py py-mod docutils literal notranslate"><span class="pre">threading</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sansio/server.html">Server (Sans-I/O)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sansio/client.html">Client (Sans-I/O)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/legacy/server.html">Server (legacy <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/legacy/client.html">Client (legacy <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/extensions.html">Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/datastructures.html">Data structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/exceptions.html">Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/types.html">Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/variables.html">Environment variables</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="index.html">Topic guides</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Topic guides</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="deployment.html">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="authentication.html">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="broadcast.html">Broadcasting</a></li>
<li class="toctree-l2"><a class="reference internal" href="compression.html">Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="keepalive.html">Keepalive and latency</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory.html">Memory and buffers</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance.html">Performance</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../project/index.html">About websockets</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of About websockets</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../project/changelog.html">Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/contributing.html">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/sponsoring.html">Sponsoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/tidelift.html">For enterprise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/support.html">Getting support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/license.html">License</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="design.html#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="design-legacy-asyncio">
<h1>Design (legacy <a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code></a>)<a class="headerlink" href="design.html#design-legacy-asyncio" title="Link to this heading">¶</a></h1>
<p>This document describes the design of the legacy implementation of websockets.
It assumes familiarity with the specification of the WebSocket protocol in
<span class="target" id="index-0"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6455.html"><strong>RFC 6455</strong></a>.</p>
<p>It’s primarily intended at maintainers. It may also be useful for users who
wish to understand what happens under the hood.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Internals described in this document may change at any time.</p>
<p>Backwards compatibility is only guaranteed for <a class="reference internal" href="../reference/index.html"><span class="doc">public APIs</span></a>.</p>
</div>
<section id="lifecycle">
<h2>Lifecycle<a class="headerlink" href="design.html#lifecycle" title="Link to this heading">¶</a></h2>
<section id="state">
<h3>State<a class="headerlink" href="design.html#state" title="Link to this heading">¶</a></h3>
<p>WebSocket connections go through a trivial state machine:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CONNECTING</span></code>: initial state,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OPEN</span></code>: when the opening handshake is complete,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CLOSING</span></code>: when the closing handshake is started,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CLOSED</span></code>: when the TCP connection is closed.</p></li>
</ul>
<p>Transitions happen in the following places:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CONNECTING</span> <span class="pre">-&gt;</span> <span class="pre">OPEN</span></code>: in
<code class="xref py py-meth docutils literal notranslate"><span class="pre">connection_open()</span></code> which runs when the
<a class="reference internal" href="design.html#opening-handshake"><span class="std std-ref">opening handshake</span></a> completes and the WebSocket
connection is established — not to be confused with
<a class="reference external" href="https://docs.python.org/3/library/asyncio-protocol.html#asyncio.BaseProtocol.connection_made" title="(in Python v3.13)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">connection_made()</span></code></a> which runs when the TCP
connection is established;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OPEN</span> <span class="pre">-&gt;</span> <span class="pre">CLOSING</span></code>: in <code class="xref py py-meth docutils literal notranslate"><span class="pre">write_frame()</span></code>
immediately before sending a close frame; since receiving a close frame
triggers sending a close frame, this does the right thing regardless of which
side started the <a class="reference internal" href="design.html#closing-handshake"><span class="std std-ref">closing handshake</span></a>; also in
<code class="xref py py-meth docutils literal notranslate"><span class="pre">fail_connection()</span></code> which duplicates a
few lines of code from <code class="docutils literal notranslate"><span class="pre">write_close_frame()</span></code> and <code class="docutils literal notranslate"><span class="pre">write_frame()</span></code>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">*</span> <span class="pre">-&gt;</span> <span class="pre">CLOSED</span></code>: in <code class="xref py py-meth docutils literal notranslate"><span class="pre">connection_lost()</span></code>
which is always called exactly once when the TCP connection is closed.</p></li>
</ul>
</section>
<section id="coroutines">
<h3>Coroutines<a class="headerlink" href="design.html#coroutines" title="Link to this heading">¶</a></h3>
<p>The following diagram shows which coroutines are running at each stage of the
connection lifecycle on the client side.</p>
<a class="reference external image-reference" href="https://websockets.readthedocs.io/en/stable/topics/_images/lifecycle.svg"><img alt="../_images/lifecycle.svg" src="../_images/lifecycle.svg" />
</a>
<p>The lifecycle is identical on the server side, except inversion of control makes
the equivalent of <a class="reference internal" href="../reference/legacy/client.html#websockets.legacy.client.connect" title="websockets.legacy.client.connect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">connect()</span></code></a> implicit.</p>
<p>Coroutines shown in green are called by the application. Multiple coroutines
may interact with the WebSocket connection concurrently.</p>
<p>Coroutines shown in gray manage the connection. When the opening handshake
succeeds, <code class="xref py py-meth docutils literal notranslate"><span class="pre">connection_open()</span></code> starts two
tasks:</p>
<ul class="simple">
<li><p><code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> runs
<code class="xref py py-meth docutils literal notranslate"><span class="pre">transfer_data()</span></code> which handles incoming
data and lets <a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.recv" title="websockets.legacy.protocol.WebSocketCommonProtocol.recv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a> consume it. It
may be canceled to terminate the connection. It never exits with an exception
other than <a class="reference external" href="https://docs.python.org/3/library/asyncio-exceptions.html#asyncio.CancelledError" title="(in Python v3.13)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">CancelledError</span></code></a>. See <a class="reference internal" href="design.html#data-transfer"><span class="std std-ref">data transfer</span></a> below.</p></li>
<li><p><code class="xref py py-attr docutils literal notranslate"><span class="pre">keepalive_ping_task</span></code> runs
<code class="xref py py-meth docutils literal notranslate"><span class="pre">keepalive_ping()</span></code> which sends Ping
frames at regular intervals and ensures that corresponding Pong frames are
received. It is canceled when the connection terminates. It never exits with
an exception other than <a class="reference external" href="https://docs.python.org/3/library/asyncio-exceptions.html#asyncio.CancelledError" title="(in Python v3.13)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">CancelledError</span></code></a>.</p></li>
<li><p><code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code> runs
<code class="xref py py-meth docutils literal notranslate"><span class="pre">close_connection()</span></code> which waits for the
data transfer to terminate, then takes care of closing the TCP connection. It
must not be canceled. It never exits with an exception. See <a class="reference internal" href="design.html#connection-termination"><span class="std std-ref">connection
termination</span></a> below.</p></li>
</ul>
<p>Besides, <code class="xref py py-meth docutils literal notranslate"><span class="pre">fail_connection()</span></code> starts the
same <code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code> when the
opening handshake fails, in order to close the TCP connection.</p>
<p>Splitting the responsibilities between two tasks makes it easier to guarantee
that websockets can terminate connections:</p>
<ul class="simple">
<li><p>within a fixed timeout,</p></li>
<li><p>without leaking pending tasks,</p></li>
<li><p>without leaking open TCP connections,</p></li>
</ul>
<p>regardless of whether the connection terminates normally or abnormally.</p>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> completes when no
more data will be received on the connection. Under normal circumstances, it
exits after exchanging close frames.</p>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code> completes when
the TCP connection is closed.</p>
</section>
</section>
<section id="opening-handshake">
<span id="id1"></span><h2>Opening handshake<a class="headerlink" href="design.html#opening-handshake" title="Link to this heading">¶</a></h2>
<p>websockets performs the opening handshake when establishing a WebSocket
connection. On the client side, <a class="reference internal" href="../reference/legacy/client.html#websockets.legacy.client.connect" title="websockets.legacy.client.connect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">connect()</span></code></a> executes it before
returning the protocol to the caller. On the server side, it’s executed before
passing the protocol to the <code class="docutils literal notranslate"><span class="pre">ws_handler</span></code> coroutine handling the connection.</p>
<p>While the opening handshake is asymmetrical — the client sends an HTTP Upgrade
request and the server replies with an HTTP Switching Protocols response —
websockets aims at keeping the implementation of both sides consistent with
one another.</p>
<p>On the client side, <code class="xref py py-meth docutils literal notranslate"><span class="pre">handshake()</span></code>:</p>
<ul class="simple">
<li><p>builds an HTTP request based on the <code class="docutils literal notranslate"><span class="pre">uri</span></code> and parameters passed to
<a class="reference internal" href="../reference/legacy/client.html#websockets.legacy.client.connect" title="websockets.legacy.client.connect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">connect()</span></code></a>;</p></li>
<li><p>writes the HTTP request to the network;</p></li>
<li><p>reads an HTTP response from the network;</p></li>
<li><p>checks the HTTP response, validates <code class="docutils literal notranslate"><span class="pre">extensions</span></code> and <code class="docutils literal notranslate"><span class="pre">subprotocol</span></code>, and
configures the protocol accordingly;</p></li>
<li><p>moves to the <code class="docutils literal notranslate"><span class="pre">OPEN</span></code> state.</p></li>
</ul>
<p>On the server side, <code class="xref py py-meth docutils literal notranslate"><span class="pre">handshake()</span></code>:</p>
<ul class="simple">
<li><p>reads an HTTP request from the network;</p></li>
<li><p>calls <a class="reference internal" href="../reference/legacy/server.html#websockets.legacy.server.WebSocketServerProtocol.process_request" title="websockets.legacy.server.WebSocketServerProtocol.process_request"><code class="xref py py-meth docutils literal notranslate"><span class="pre">process_request()</span></code></a> which may abort
the WebSocket handshake and return an HTTP response instead; this hook only
makes sense on the server side;</p></li>
<li><p>checks the HTTP request, negotiates <code class="docutils literal notranslate"><span class="pre">extensions</span></code> and <code class="docutils literal notranslate"><span class="pre">subprotocol</span></code>, and
configures the protocol accordingly;</p></li>
<li><p>builds an HTTP response based on the above and parameters passed to
<a class="reference internal" href="../reference/legacy/server.html#websockets.legacy.server.serve" title="websockets.legacy.server.serve"><code class="xref py py-meth docutils literal notranslate"><span class="pre">serve()</span></code></a>;</p></li>
<li><p>writes the HTTP response to the network;</p></li>
<li><p>moves to the <code class="docutils literal notranslate"><span class="pre">OPEN</span></code> state;</p></li>
<li><p>returns the <code class="docutils literal notranslate"><span class="pre">path</span></code> part of the <code class="docutils literal notranslate"><span class="pre">uri</span></code>.</p></li>
</ul>
<p>The most significant asymmetry between the two sides of the opening handshake
lies in the negotiation of extensions and, to a lesser extent, of the
subprotocol. The server knows everything about both sides and decides what the
parameters should be for the connection. The client merely applies them.</p>
<p>If anything goes wrong during the opening handshake, websockets <a class="reference internal" href="design.html#connection-failure"><span class="std std-ref">fails
the connection</span></a>.</p>
</section>
<section id="data-transfer">
<span id="id2"></span><h2>Data transfer<a class="headerlink" href="design.html#data-transfer" title="Link to this heading">¶</a></h2>
<section id="symmetry">
<h3>Symmetry<a class="headerlink" href="design.html#symmetry" title="Link to this heading">¶</a></h3>
<p>Once the opening handshake has completed, the WebSocket protocol enters the
data transfer phase. This part is almost symmetrical. There are only two
differences between a server and a client:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc6455.html#section-5.3">client-to-server masking</a>: the client masks outgoing frames; the server
unmasks incoming frames;</p></li>
<li><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc6455.html#section-5.5.1">closing the TCP connection</a>: the server closes the connection immediately;
the client waits for the server to do it.</p></li>
</ul>
<p>These differences are so minor that all the logic for <a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc6455.html#section-5">data framing</a>, for
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc6455.html#section-6">sending and receiving data</a> and for <a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc6455.html#section-7">closing the connection</a> is implemented
in the same class, <a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol" title="websockets.legacy.protocol.WebSocketCommonProtocol"><code class="xref py py-class docutils literal notranslate"><span class="pre">WebSocketCommonProtocol</span></code></a>.</p>
<p>The <code class="xref py py-attr docutils literal notranslate"><span class="pre">is_client</span></code> attribute tells which
side a protocol instance is managing. This attribute is defined on the
<a class="reference internal" href="../reference/legacy/server.html#websockets.legacy.server.WebSocketServerProtocol" title="websockets.legacy.server.WebSocketServerProtocol"><code class="xref py py-attr docutils literal notranslate"><span class="pre">WebSocketServerProtocol</span></code></a> and
<a class="reference internal" href="../reference/legacy/client.html#websockets.legacy.client.WebSocketClientProtocol" title="websockets.legacy.client.WebSocketClientProtocol"><code class="xref py py-attr docutils literal notranslate"><span class="pre">WebSocketClientProtocol</span></code></a> classes.</p>
</section>
<section id="data-flow">
<h3>Data flow<a class="headerlink" href="design.html#data-flow" title="Link to this heading">¶</a></h3>
<p>The following diagram shows how data flows between an application built on top
of websockets and a remote endpoint. It applies regardless of which side is
the server or the client.</p>
<a class="reference external image-reference" href="https://websockets.readthedocs.io/en/stable/topics/_images/protocol.svg"><img alt="../_images/protocol.svg" src="../_images/protocol.svg" />
</a>
<p>Public methods are shown in green, private methods in yellow, and buffers in
orange. Methods related to connection termination are omitted; connection
termination is discussed in another section below.</p>
</section>
<section id="receiving-data">
<h3>Receiving data<a class="headerlink" href="design.html#receiving-data" title="Link to this heading">¶</a></h3>
<p>The left side of the diagram shows how websockets receives data.</p>
<p>Incoming data is written to a <a class="reference external" href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamReader" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">StreamReader</span></code></a> in order to
implement flow control and provide backpressure on the TCP connection.</p>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code>, which is started
when the WebSocket connection is established, processes this data.</p>
<p>When it receives data frames, it reassembles fragments and puts the resulting
messages in the <code class="xref py py-attr docutils literal notranslate"><span class="pre">messages</span></code> queue.</p>
<p>When it encounters a control frame:</p>
<ul class="simple">
<li><p>if it’s a close frame, it starts the closing handshake;</p></li>
<li><p>if it’s a ping frame, it answers with a pong frame;</p></li>
<li><p>if it’s a pong frame, it acknowledges the corresponding ping (unless it’s an
unsolicited pong).</p></li>
</ul>
<p>Running this process in a task guarantees that control frames are processed
promptly. Without such a task, websockets would depend on the application to
drive the connection by having exactly one coroutine awaiting
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.recv" title="websockets.legacy.protocol.WebSocketCommonProtocol.recv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a> at any time. While this happens
naturally in many use cases, it cannot be relied upon.</p>
<p>Then <a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.recv" title="websockets.legacy.protocol.WebSocketCommonProtocol.recv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a> fetches the next message
from the <code class="xref py py-attr docutils literal notranslate"><span class="pre">messages</span></code> queue, with some
complexity added for handling backpressure and termination correctly.</p>
</section>
<section id="sending-data">
<h3>Sending data<a class="headerlink" href="design.html#sending-data" title="Link to this heading">¶</a></h3>
<p>The right side of the diagram shows how websockets sends data.</p>
<p><a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.send" title="websockets.legacy.protocol.WebSocketCommonProtocol.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> writes one or several data frames
containing the message. While sending a fragmented message, concurrent calls to
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.send" title="websockets.legacy.protocol.WebSocketCommonProtocol.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> are put on hold until all
fragments are sent. This makes concurrent calls safe.</p>
<p><a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.ping" title="websockets.legacy.protocol.WebSocketCommonProtocol.ping"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ping()</span></code></a> writes a ping frame and yields a
<a class="reference external" href="https://docs.python.org/3/library/asyncio-future.html#asyncio.Future" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Future</span></code></a> which will be completed when a matching pong frame is
received.</p>
<p><a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.pong" title="websockets.legacy.protocol.WebSocketCommonProtocol.pong"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pong()</span></code></a> writes a pong frame.</p>
<p><a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.close" title="websockets.legacy.protocol.WebSocketCommonProtocol.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code></a> writes a close frame and waits
for the TCP connection to terminate.</p>
<p>Outgoing data is written to a <a class="reference external" href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamWriter" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">StreamWriter</span></code></a> in order to
implement flow control and provide backpressure from the TCP connection.</p>
</section>
<section id="closing-handshake">
<span id="id3"></span><h3>Closing handshake<a class="headerlink" href="design.html#closing-handshake" title="Link to this heading">¶</a></h3>
<p>When the other side of the connection initiates the closing handshake,
<code class="xref py py-meth docutils literal notranslate"><span class="pre">read_message()</span></code> receives a close frame
while in the <code class="docutils literal notranslate"><span class="pre">OPEN</span></code> state. It moves to the <code class="docutils literal notranslate"><span class="pre">CLOSING</span></code> state, sends a close
frame, and returns <a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a>, causing
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> to terminate.</p>
<p>When this side of the connection initiates the closing handshake with
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.close" title="websockets.legacy.protocol.WebSocketCommonProtocol.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code></a>, it moves to the <code class="docutils literal notranslate"><span class="pre">CLOSING</span></code>
state and sends a close frame. When the other side sends a close frame,
<code class="xref py py-meth docutils literal notranslate"><span class="pre">read_message()</span></code> receives it in the
<code class="docutils literal notranslate"><span class="pre">CLOSING</span></code> state and returns <a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a>, also causing
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> to terminate.</p>
<p>If the other side doesn’t send a close frame within the connection’s close
timeout, websockets <a class="reference internal" href="design.html#connection-failure"><span class="std std-ref">fails the connection</span></a>.</p>
<p>The closing handshake can take up to <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">*</span> <span class="pre">close_timeout</span></code>: one
<code class="docutils literal notranslate"><span class="pre">close_timeout</span></code> to write a close frame and one <code class="docutils literal notranslate"><span class="pre">close_timeout</span></code> to receive
a close frame.</p>
<p>Then websockets terminates the TCP connection.</p>
</section>
</section>
<section id="connection-termination">
<span id="id4"></span><h2>Connection termination<a class="headerlink" href="design.html#connection-termination" title="Link to this heading">¶</a></h2>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code>, which is
started when the WebSocket connection is established, is responsible for
eventually closing the TCP connection.</p>
<p>First <code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code> waits for
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> to terminate, which
may happen as a result of:</p>
<ul class="simple">
<li><p>a successful closing handshake: as explained above, this exits the infinite
loop in <code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code>;</p></li>
<li><p>a timeout while waiting for the closing handshake to complete: this cancels
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code>;</p></li>
<li><p>a protocol error, including connection errors: depending on the exception,
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> <a class="reference internal" href="design.html#connection-failure"><span class="std std-ref">fails the
connection</span></a> with a suitable code and exits.</p></li>
</ul>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code> is separate from
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> to make it easier
to implement the timeout on the closing handshake. Canceling
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> creates no risk of
canceling <code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code> and
failing to close the TCP connection, thus leaking resources.</p>
<p>Then <code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code> cancels
<code class="xref py py-meth docutils literal notranslate"><span class="pre">keepalive_ping()</span></code>. This task has no
protocol compliance responsibilities. Terminating it to avoid leaking it is the
only concern.</p>
<p>Terminating the TCP connection can take up to <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">*</span> <span class="pre">close_timeout</span></code> on the
server side and <code class="docutils literal notranslate"><span class="pre">3</span> <span class="pre">*</span> <span class="pre">close_timeout</span></code> on the client side. Clients start by
waiting for the server to close the connection, hence the extra
<code class="docutils literal notranslate"><span class="pre">close_timeout</span></code>. Then both sides go through the following steps until the
TCP connection is lost: half-closing the connection (only for non-TLS
connections), closing the connection, aborting the connection. At this point
the connection drops regardless of what happens on the network.</p>
</section>
<section id="connection-failure">
<span id="id5"></span><h2>Connection failure<a class="headerlink" href="design.html#connection-failure" title="Link to this heading">¶</a></h2>
<p>If the opening handshake doesn’t complete successfully, websockets fails the
connection by closing the TCP connection.</p>
<p>Once the opening handshake has completed, websockets fails the connection by
canceling <code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> and
sending a close frame if appropriate.</p>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> exits, unblocking
<code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code>, which closes
the TCP connection.</p>
</section>
<section id="server-shutdown">
<span id="id6"></span><h2>Server shutdown<a class="headerlink" href="design.html#server-shutdown" title="Link to this heading">¶</a></h2>
<p><a class="reference internal" href="../reference/legacy/server.html#websockets.legacy.server.WebSocketServer" title="websockets.legacy.server.WebSocketServer"><code class="xref py py-class docutils literal notranslate"><span class="pre">WebSocketServer</span></code></a> closes asynchronously like
<a class="reference external" href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.Server" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.Server</span></code></a>. The shutdown happen in two steps:</p>
<ol class="arabic simple">
<li><p>Stop listening and accepting new connections;</p></li>
<li><p>Close established connections with close code 1001 (going away) or, if
the opening handshake is still in progress, with HTTP status code 503
(Service Unavailable).</p></li>
</ol>
<p>The first call to <a class="reference internal" href="../reference/legacy/server.html#websockets.legacy.server.WebSocketServer.close" title="websockets.legacy.server.WebSocketServer.close"><code class="xref py py-class docutils literal notranslate"><span class="pre">close</span></code></a> starts a task that
performs this sequence. Further calls are ignored. This is the easiest way to
make <a class="reference internal" href="../reference/legacy/server.html#websockets.legacy.server.WebSocketServer.close" title="websockets.legacy.server.WebSocketServer.close"><code class="xref py py-class docutils literal notranslate"><span class="pre">close</span></code></a> and
<a class="reference internal" href="../reference/legacy/server.html#websockets.legacy.server.WebSocketServer.wait_closed" title="websockets.legacy.server.WebSocketServer.wait_closed"><code class="xref py py-class docutils literal notranslate"><span class="pre">wait_closed</span></code></a> idempotent.</p>
</section>
<section id="cancellation">
<span id="id7"></span><h2>Cancellation<a class="headerlink" href="design.html#cancellation" title="Link to this heading">¶</a></h2>
<section id="user-code">
<h3>User code<a class="headerlink" href="design.html#user-code" title="Link to this heading">¶</a></h3>
<p>websockets provides a WebSocket application server. It manages connections and
passes them to user-provided connection handlers. This is an <em>inversion of
control</em> scenario: library code calls user code.</p>
<p>If a connection drops, the corresponding handler should terminate. If the
server shuts down, all connection handlers must terminate. Canceling
connection handlers would terminate them.</p>
<p>However, using cancellation for this purpose would require all connection
handlers to handle it properly. For example, if a connection handler starts
some tasks, it should catch <a class="reference external" href="https://docs.python.org/3/library/asyncio-exceptions.html#asyncio.CancelledError" title="(in Python v3.13)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">CancelledError</span></code></a>, terminate or
cancel these tasks, and then re-raise the exception.</p>
<p>Cancellation is tricky in <a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code></a> applications, especially when it
interacts with finalization logic. In the example above, what if a handler
gets interrupted with <a class="reference external" href="https://docs.python.org/3/library/asyncio-exceptions.html#asyncio.CancelledError" title="(in Python v3.13)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">CancelledError</span></code></a> while it’s finalizing
the tasks it started, after detecting that the connection dropped?</p>
<p>websockets considers that cancellation may only be triggered by the caller of
a coroutine when it doesn’t care about the results of that coroutine anymore.
(Source: <a class="reference external" href="https://groups.google.com/forum/#!msg/python-tulip/LZQe38CR3bg/7qZ1p_q5yycJ">Guido van Rossum</a>). Since connection handlers run
arbitrary user code, websockets has no way of deciding whether that code is
still doing something worth caring about.</p>
<p>For these reasons, websockets never cancels connection handlers. Instead it
expects them to detect when the connection is closed, execute finalization
logic if needed, and exit.</p>
<p>Conversely, cancellation isn’t a concern for WebSocket clients because they
don’t involve inversion of control.</p>
</section>
<section id="library">
<h3>Library<a class="headerlink" href="design.html#library" title="Link to this heading">¶</a></h3>
<p>Most <a class="reference internal" href="../reference/index.html"><span class="doc">public APIs</span></a> of websockets are coroutines.
They may be canceled, for example if the user starts a task that calls these
coroutines and cancels the task later. websockets must handle this situation.</p>
<p>Cancellation during the opening handshake is handled like any other exception:
the TCP connection is closed and the exception is re-raised. This can only
happen on the client side. On the server side, the opening handshake is
managed by websockets and nothing results in a cancellation.</p>
<p>Once the WebSocket connection is established, internal tasks
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> and
<code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code> mustn’t get
accidentally canceled if a coroutine that awaits them is canceled. In other
words, they must be shielded from cancellation.</p>
<p><a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.recv" title="websockets.legacy.protocol.WebSocketCommonProtocol.recv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a> waits for the next message in the
queue or for <code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> to
terminate, whichever comes first. It relies on <a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.wait" title="(in Python v3.13)"><code class="xref py py-func docutils literal notranslate"><span class="pre">wait()</span></code></a> for waiting
on two futures in parallel. As a consequence, even though it’s waiting on a
<a class="reference external" href="https://docs.python.org/3/library/asyncio-future.html#asyncio.Future" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Future</span></code></a> signaling the next message and on
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code>, it doesn’t
propagate cancellation to them.</p>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">ensure_open()</span></code> is called by
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.send" title="websockets.legacy.protocol.WebSocketCommonProtocol.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a>,
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.ping" title="websockets.legacy.protocol.WebSocketCommonProtocol.ping"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ping()</span></code></a>, and
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.pong" title="websockets.legacy.protocol.WebSocketCommonProtocol.pong"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pong()</span></code></a>. When the connection state is
<code class="docutils literal notranslate"><span class="pre">CLOSING</span></code>, it waits for
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> but shields it to
prevent cancellation.</p>
<p><a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.close" title="websockets.legacy.protocol.WebSocketCommonProtocol.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code></a> waits for the data transfer task
to terminate with <a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.timeout" title="(in Python v3.13)"><code class="xref py py-func docutils literal notranslate"><span class="pre">timeout()</span></code></a>. If it’s canceled or if the timeout
elapses, <code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> is
canceled, which is correct at this point.
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.close" title="websockets.legacy.protocol.WebSocketCommonProtocol.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code></a> then waits for
<code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code> but shields it
to prevent cancellation.</p>
<p><a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.close" title="websockets.legacy.protocol.WebSocketCommonProtocol.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code></a> and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">fail_connection()</span></code> are the only places
where <code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> may be
canceled.</p>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code> starts by
waiting for <code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code>. It
catches <a class="reference external" href="https://docs.python.org/3/library/asyncio-exceptions.html#asyncio.CancelledError" title="(in Python v3.13)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">CancelledError</span></code></a> to prevent a cancellation of
<code class="xref py py-attr docutils literal notranslate"><span class="pre">transfer_data_task</span></code> from propagating to
<code class="xref py py-attr docutils literal notranslate"><span class="pre">close_connection_task</span></code>.</p>
</section>
</section>
<section id="backpressure">
<span id="id8"></span><h2>Backpressure<a class="headerlink" href="design.html#backpressure" title="Link to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section discusses backpressure from the perspective of a server but
the concept applies to clients symmetrically.</p>
</div>
<p>With a naive implementation, if a server receives inputs faster than it can
process them, or if it generates outputs faster than it can send them, data
accumulates in buffers, eventually causing the server to run out of memory and
crash.</p>
<p>The solution to this problem is backpressure. Any part of the server that
receives inputs faster than it can process them and send the outputs
must propagate that information back to the previous part in the chain.</p>
<p>websockets is designed to make it easy to get backpressure right.</p>
<p>For incoming data, websockets builds upon <a class="reference external" href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamReader" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">StreamReader</span></code></a> which
propagates backpressure to its own buffer and to the TCP stream. Frames are
parsed from the input stream and added to a bounded queue. If the queue fills
up, parsing halts until the application reads a frame.</p>
<p>For outgoing data, websockets builds upon <a class="reference external" href="https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamWriter" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">StreamWriter</span></code></a> which
implements flow control. If the output buffers grow too large, it waits until
they’re drained. That’s why all APIs that write frames are asynchronous.</p>
<p>Of course, it’s still possible for an application to create its own unbounded
buffers and break the backpressure. Be careful with queues.</p>
</section>
<section id="concurrency">
<h2>Concurrency<a class="headerlink" href="design.html#concurrency" title="Link to this heading">¶</a></h2>
<p>Awaiting any combination of <a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.recv" title="websockets.legacy.protocol.WebSocketCommonProtocol.recv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a>,
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.send" title="websockets.legacy.protocol.WebSocketCommonProtocol.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a>,
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.close" title="websockets.legacy.protocol.WebSocketCommonProtocol.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code></a>
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.ping" title="websockets.legacy.protocol.WebSocketCommonProtocol.ping"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ping()</span></code></a>, or
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.pong" title="websockets.legacy.protocol.WebSocketCommonProtocol.pong"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pong()</span></code></a> concurrently is safe, including
multiple calls to the same method, with one exception and one limitation.</p>
<ul class="simple">
<li><p><strong>Only one coroutine can receive messages at a time.</strong> This constraint avoids
non-deterministic behavior (and simplifies the implementation). If a coroutine
is awaiting <a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.recv" title="websockets.legacy.protocol.WebSocketCommonProtocol.recv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a>, awaiting it again
in another coroutine raises <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#RuntimeError" title="(in Python v3.13)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">RuntimeError</span></code></a>.</p></li>
<li><p><strong>Sending a fragmented message forces serialization.</strong> Indeed, the WebSocket
protocol doesn’t support multiplexing messages. If a coroutine is awaiting
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.send" title="websockets.legacy.protocol.WebSocketCommonProtocol.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> to send a fragmented message,
awaiting it again in another coroutine waits until the first call completes.
This will be transparent in many cases. It may be a concern if the fragmented
message is generated slowly by an asynchronous iterator.</p></li>
</ul>
<p>Receiving frames is independent from sending frames. This isolates
<a class="reference internal" href="../reference/legacy/common.html#websockets.legacy.protocol.WebSocketCommonProtocol.recv" title="websockets.legacy.protocol.WebSocketCommonProtocol.recv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a>, which receives frames, from the
other methods, which send frames.</p>
<p>While the connection is open, each frame is sent with a single write. Combined
with the concurrency model of <a class="reference external" href="https://docs.python.org/3/library/asyncio.html#module-asyncio" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code></a>, this enforces serialization. The
only other requirement is to prevent interleaving other data frames in the
middle of a fragmented message.</p>
<p>After the connection is closed, sending a frame raises
<a class="reference internal" href="../reference/exceptions.html#websockets.exceptions.ConnectionClosed" title="websockets.exceptions.ConnectionClosed"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ConnectionClosed</span></code></a>, which is safe.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2013-2024, Aymeric Augustin and contributors
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="design.html#">Design (legacy <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a><ul>
<li><a class="reference internal" href="design.html#lifecycle">Lifecycle</a><ul>
<li><a class="reference internal" href="design.html#state">State</a></li>
<li><a class="reference internal" href="design.html#coroutines">Coroutines</a></li>
</ul>
</li>
<li><a class="reference internal" href="design.html#opening-handshake">Opening handshake</a></li>
<li><a class="reference internal" href="design.html#data-transfer">Data transfer</a><ul>
<li><a class="reference internal" href="design.html#symmetry">Symmetry</a></li>
<li><a class="reference internal" href="design.html#data-flow">Data flow</a></li>
<li><a class="reference internal" href="design.html#receiving-data">Receiving data</a></li>
<li><a class="reference internal" href="design.html#sending-data">Sending data</a></li>
<li><a class="reference internal" href="design.html#closing-handshake">Closing handshake</a></li>
</ul>
</li>
<li><a class="reference internal" href="design.html#connection-termination">Connection termination</a></li>
<li><a class="reference internal" href="design.html#connection-failure">Connection failure</a></li>
<li><a class="reference internal" href="design.html#server-shutdown">Server shutdown</a></li>
<li><a class="reference internal" href="design.html#cancellation">Cancellation</a><ul>
<li><a class="reference internal" href="design.html#user-code">User code</a></li>
<li><a class="reference internal" href="design.html#library">Library</a></li>
</ul>
</li>
<li><a class="reference internal" href="design.html#backpressure">Backpressure</a></li>
<li><a class="reference internal" href="design.html#concurrency">Concurrency</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js%3Fv=03fa008d"></script>
    <script src="../_static/doctools.js%3Fv=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js%3Fv=dc90522c"></script>
    <script src="../_static/scripts/furo.js%3Fv=5fa4622c"></script>
    <script src="../_static/clipboard.min.js%3Fv=a7894cd8"></script>
    <script src="../_static/copybutton.js%3Fv=f281be69"></script>
    <script src="../_static/tabs.js%3Fv=3ee01567"></script>
    </body>
</html>