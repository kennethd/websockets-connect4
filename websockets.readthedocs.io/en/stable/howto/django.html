<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Integrate with Django" />
<meta property="og:type" content="website" />
<meta property="og:url" content="howto/django.html" />
<meta property="og:site_name" content="websockets" />
<meta property="og:description" content="If you’re looking at adding real-time capabilities to a Django project with WebSocket, you have two main options. Using Django Channels, a project adding WebSocket to Django, among other features. ..." />
<meta name="description" content="If you’re looking at adding real-time capabilities to a Django project with WebSocket, you have two main options. Using Django Channels, a project adding WebSocket to Django, among other features. ..." />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Write an extension" href="extensions.html" /><link rel="prev" title="Reload on code changes" href="autoreload.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>Integrate with Django - websockets 14.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css%3Fv=a746c00c.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css%3Fv=354aac6f.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css%3Fv=76b2166b.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css%3Fv=4c969af8.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css%3Fv=302659d7.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #306998;
  --color-brand-content: #0b487a;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #ffd43bcc;
  --color-brand-content: #ffd43bd9;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #ffd43bcc;
  --color-brand-content: #ffd43bd9;
  
      }
    }
  }
</style><script async type="text/javascript" src="../../../_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="websockets" /><meta name="readthedocs-version-slug" content="stable" /><meta name="readthedocs-resolver-filename" content="/howto/django.html" /><meta name="readthedocs-http-status" content="200" /></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="django.html#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">websockets 14.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/websockets.svg" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../intro/index.html">Getting started</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Getting started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/tutorial1.html">Part 1 - Send &amp; receive</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/tutorial2.html">Part 2 - Route &amp; broadcast</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/tutorial3.html">Part 3 - Deploy to the web</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">How-to guides</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of How-to guides</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">Quick start</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade.html">Upgrade to the new <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code> implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="cheatsheet.html">Cheat sheet</a></li>
<li class="toctree-l2"><a class="reference internal" href="patterns.html">Patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="autoreload.html">Reload on code changes</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="django.html#">Integrate with Django</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensions.html">Write an extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="render.html">Deploy to Render</a></li>
<li class="toctree-l2"><a class="reference internal" href="fly.html">Deploy to Fly</a></li>
<li class="toctree-l2"><a class="reference internal" href="heroku.html">Deploy to Heroku</a></li>
<li class="toctree-l2"><a class="reference internal" href="kubernetes.html">Deploy to Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="supervisor.html">Deploy with Supervisor</a></li>
<li class="toctree-l2"><a class="reference internal" href="nginx.html">Deploy behind nginx</a></li>
<li class="toctree-l2"><a class="reference internal" href="haproxy.html">Deploy behind HAProxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="sansio.html">Integrate the Sans-I/O layer</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../faq/index.html">Frequently asked questions</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Frequently asked questions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/server.html">Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/client.html">Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/common.html">Both sides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/asyncio.html">Using asyncio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/features.html">Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/asyncio/server.html">Server (new <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/asyncio/client.html">Client (new <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sync/server.html">Server (<code class="xref py py-mod docutils literal notranslate"><span class="pre">threading</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sync/client.html">Client (<code class="xref py py-mod docutils literal notranslate"><span class="pre">threading</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sansio/server.html">Server (Sans-I/O)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sansio/client.html">Client (Sans-I/O)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/legacy/server.html">Server (legacy <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/legacy/client.html">Client (legacy <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/extensions.html">Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/datastructures.html">Data structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/exceptions.html">Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/types.html">Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/variables.html">Environment variables</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../topics/index.html">Topic guides</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Topic guides</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../topics/deployment.html">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/authentication.html">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/broadcast.html">Broadcasting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/compression.html">Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/keepalive.html">Keepalive and latency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/memory.html">Memory and buffers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/performance.html">Performance</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../project/index.html">About websockets</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of About websockets</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../project/changelog.html">Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/contributing.html">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/sponsoring.html">Sponsoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/tidelift.html">For enterprise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/support.html">Getting support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/license.html">License</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="django.html#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="integrate-with-django">
<h1>Integrate with Django<a class="headerlink" href="django.html#integrate-with-django" title="Link to this heading">¶</a></h1>
<p>If you’re looking at adding real-time capabilities to a Django project with
WebSocket, you have two main options.</p>
<ol class="arabic simple">
<li><p>Using Django <a class="reference external" href="https://channels.readthedocs.io/">Channels</a>, a project adding WebSocket to Django, among other
features. This approach is fully supported by Django. However, it requires
switching to a new deployment architecture.</p></li>
<li><p>Deploying a separate WebSocket server next to your Django project. This
technique is well suited when you need to add a small set of real-time
features — maybe a notification service — to an HTTP application.</p></li>
</ol>
<p>This guide shows how to implement the second technique with websockets. It
assumes familiarity with Django.</p>
<section id="authenticate-connections">
<h2>Authenticate connections<a class="headerlink" href="django.html#authenticate-connections" title="Link to this heading">¶</a></h2>
<p>Since the websockets server runs outside of Django, we need to integrate it
with <code class="docutils literal notranslate"><span class="pre">django.contrib.auth</span></code>.</p>
<p>We will generate authentication tokens in the Django project. Then we will
send them to the websockets server, where they will authenticate the user.</p>
<p>Generating a token for the current user and making it available in the browser
is up to you. You could render the token in a template or fetch it with an API
call.</p>
<p>Refer to the topic guide on <a class="reference internal" href="../topics/authentication.html"><span class="doc">authentication</span></a>
for details on this design.</p>
<section id="generate-tokens">
<h3>Generate tokens<a class="headerlink" href="django.html#generate-tokens" title="Link to this heading">¶</a></h3>
<p>We want secure, short-lived tokens containing the user ID. We’ll rely on
<a class="reference external" href="https://github.com/aaugustin/django-sesame">django-sesame</a>, a small library designed exactly for this purpose.</p>
<p>Add django-sesame to the dependencies of your Django project, install it, and
configure it in the settings of the project:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AUTHENTICATION_BACKENDS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;django.contrib.auth.backends.ModelBackend&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sesame.backends.ModelBackend&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<p>(If your project already uses another authentication backend than the default
<code class="docutils literal notranslate"><span class="pre">&quot;django.contrib.auth.backends.ModelBackend&quot;</span></code>, adjust accordingly.)</p>
<p>You don’t need <code class="docutils literal notranslate"><span class="pre">&quot;sesame.middleware.AuthenticationMiddleware&quot;</span></code>. It is for
authenticating users in the Django server, while we’re authenticating them in
the websockets server.</p>
<p>We’d like our tokens to be valid for 30 seconds. We expect web pages to load
and to establish the WebSocket connection within this delay. Configure
django-sesame accordingly in the settings of your Django project:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">SESAME_MAX_AGE</span> <span class="o">=</span> <span class="mi">30</span>
</pre></div>
</div>
<p>If you expect your web site to load faster for all clients, a shorter lifespan
is possible. However, in the context of this document, it would make manual
testing more difficult.</p>
<p>You could also enable single-use tokens. However, this would update the last
login date of the user every time a WebSocket connection is established. This
doesn’t seem like a good idea, both in terms of behavior and in terms of
performance.</p>
<p>Now you can generate tokens in a <code class="docutils literal notranslate"><span class="pre">django-admin</span> <span class="pre">shell</span></code> as follows:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user_model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;&lt;your username&gt;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sesame.utils</span> <span class="kn">import</span> <span class="n">get_token</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_token</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="go">&#39;&lt;your token&gt;&#39;</span>
</pre></div>
</div>
<p>Keep this console open: since tokens expire after 30 seconds, you’ll have to
generate a new token every time you want to test connecting to the server.</p>
</section>
<section id="validate-tokens">
<h3>Validate tokens<a class="headerlink" href="django.html#validate-tokens" title="Link to this heading">¶</a></h3>
<p>Let’s move on to the websockets server.</p>
<p>Add websockets to the dependencies of your Django project and install it.
Indeed, we’re going to reuse the environment of the Django project, so we can
call its APIs in the websockets server.</p>
<p>Now here’s how to implement authentication.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">import</span> <span class="nn">django</span>

<span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">sesame.utils</span> <span class="kn">import</span> <span class="n">get_user</span>
<span class="kn">from</span> <span class="nn">websockets.asyncio.server</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">websockets.frames</span> <span class="kn">import</span> <span class="n">CloseCode</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>
    <span class="n">sesame</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">get_user</span><span class="p">,</span> <span class="n">sesame</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">CloseCode</span><span class="o">.</span><span class="n">INTERNAL_ERROR</span><span class="p">,</span> <span class="s2">&quot;authentication failed&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hello </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">serve</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">8888</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>  <span class="c1"># run forever</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>Let’s unpack this code.</p>
<p>We’re calling <code class="docutils literal notranslate"><span class="pre">django.setup()</span></code> before doing anything with Django because
we’re using Django in a <a class="reference external" href="https://docs.djangoproject.com/en/stable/topics/settings/#calling-django-setup-is-required-for-standalone-django-usage">standalone script</a>. This assumes that the
<code class="docutils literal notranslate"><span class="pre">DJANGO_SETTINGS_MODULE</span></code> environment variable is set to the Python path to
your settings module.</p>
<p>The connection handler reads the first message received from the client, which
is expected to contain a django-sesame token. Then it authenticates the user
with <code class="docutils literal notranslate"><span class="pre">get_user()</span></code>, the API for <a class="reference external" href="https://django-sesame.readthedocs.io/en/stable/howto.html#outside-a-view">authentication outside a view</a>. If
authentication fails, it closes the connection and exits.</p>
<p>When we call an API that makes a database query such as <code class="docutils literal notranslate"><span class="pre">get_user()</span></code>, we
wrap the call in <a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.to_thread" title="(in Python v3.13)"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_thread()</span></code></a>. Indeed, the Django ORM doesn’t
support asynchronous I/O. It would block the event loop if it didn’t run in a
separate thread.</p>
<p>Finally, we start a server with <a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.serve" title="websockets.asyncio.server.serve"><code class="xref py py-func docutils literal notranslate"><span class="pre">serve()</span></code></a>.</p>
<p>We’re ready to test!</p>
<p>Save this code to a file called <code class="docutils literal notranslate"><span class="pre">authentication.py</span></code>, make sure the
<code class="docutils literal notranslate"><span class="pre">DJANGO_SETTINGS_MODULE</span></code> environment variable is set properly, and start the
websockets server:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python<span class="w"> </span>authentication.py
</pre></div>
</div>
<p>Generate a new token — remember, they’re only valid for 30 seconds — and use
it to connect to your server. Paste your token and press Enter when you get a
prompt:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python<span class="w"> </span>-m<span class="w"> </span>websockets<span class="w"> </span>ws://localhost:8888/
<span class="go">Connected to ws://localhost:8888/</span>
<span class="go">&gt; &lt;your token&gt;</span>
<span class="go">&lt; Hello &lt;your username&gt;!</span>
<span class="go">Connection closed: 1000 (OK).</span>
</pre></div>
</div>
<p>It works!</p>
<p>If you enter an expired or invalid token, authentication fails and the server
closes the connection:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python<span class="w"> </span>-m<span class="w"> </span>websockets<span class="w"> </span>ws://localhost:8888/
<span class="go">Connected to ws://localhost:8888.</span>
<span class="go">&gt; not a token</span>
<span class="go">Connection closed: 1011 (internal error) authentication failed.</span>
</pre></div>
</div>
<p>You can also test from a browser by generating a new token and running the
following code in the JavaScript console of the browser:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">websocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&quot;ws://localhost:8888/&quot;</span><span class="p">);</span>
<span class="nx">websocket</span><span class="p">.</span><span class="nx">onopen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">websocket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;&lt;your token&gt;&quot;</span><span class="p">);</span>
<span class="nx">websocket</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</pre></div>
</div>
<p>If you don’t want to import your entire Django project into the websockets
server, you can build a separate Django project with <code class="docutils literal notranslate"><span class="pre">django.contrib.auth</span></code>,
<code class="docutils literal notranslate"><span class="pre">django-sesame</span></code>, a suitable <code class="docutils literal notranslate"><span class="pre">User</span></code> model, and a subset of the settings of
the main project.</p>
</section>
</section>
<section id="stream-events">
<h2>Stream events<a class="headerlink" href="django.html#stream-events" title="Link to this heading">¶</a></h2>
<p>We can connect and authenticate but our server doesn’t do anything useful yet!</p>
<p>Let’s send a message every time a user makes an action in the admin. This
message will be broadcast to all users who can access the model on which the
action was made. This may be used for showing notifications to other users.</p>
<p>Many use cases for WebSocket with Django follow a similar pattern.</p>
<section id="set-up-event-bus">
<h3>Set up event bus<a class="headerlink" href="django.html#set-up-event-bus" title="Link to this heading">¶</a></h3>
<p>We need a event bus to enable communications between Django and websockets.
Both sides connect permanently to the bus. Then Django writes events and
websockets reads them. For the sake of simplicity, we’ll rely on <a class="reference external" href="https://redis.io/topics/pubsub">Redis
Pub/Sub</a>.</p>
<p>The easiest way to add Redis to a Django project is by configuring a cache
backend with <a class="reference external" href="https://github.com/jazzband/django-redis">django-redis</a>. This library manages connections to Redis
efficiently, persisting them between requests, and provides an API to access
the Redis connection directly.</p>
<p>Install Redis, add django-redis to the dependencies of your Django project,
install it, and configure it in the settings of the project:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django_redis.cache.RedisCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;redis://127.0.0.1:6379/1&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you already have a default cache, add a new one with a different name and
change <code class="docutils literal notranslate"><span class="pre">get_redis_connection(&quot;default&quot;)</span></code> in the code below to the same name.</p>
</section>
<section id="publish-events">
<h3>Publish events<a class="headerlink" href="django.html#publish-events" title="Link to this heading">¶</a></h3>
<p>Now let’s write events to the bus.</p>
<p>Add the following code to a module that is imported when your Django project
starts. Typically, you would put it in a <code class="docutils literal notranslate"><span class="pre">signals.py</span></code> module, which you
would import in the <code class="docutils literal notranslate"><span class="pre">AppConfig.ready()</span></code> method of one of your apps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">django.contrib.admin.models</span> <span class="kn">import</span> <span class="n">LogEntry</span>
<span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>

<span class="kn">from</span> <span class="nn">django_redis</span> <span class="kn">import</span> <span class="n">get_redis_connection</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">LogEntry</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">publish_event</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">object_repr</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_change_message</span><span class="p">(),</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">action_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
        <span class="s2">&quot;content_type_id&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">content_type_id</span><span class="p">,</span>
        <span class="s2">&quot;object_id&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">get_redis_connection</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</pre></div>
</div>
<p>This code runs every time the admin saves a <code class="docutils literal notranslate"><span class="pre">LogEntry</span></code> object to keep track
of a change. It extracts interesting data, serializes it to JSON, and writes
an event to Redis.</p>
<p>Let’s check that it works:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>redis-cli
<span class="go">127.0.0.1:6379&gt; SELECT 1</span>
<span class="go">OK</span>
<span class="go">127.0.0.1:6379[1]&gt; SUBSCRIBE events</span>
<span class="go">Reading messages... (press Ctrl-C to quit)</span>
<span class="go">1) &quot;subscribe&quot;</span>
<span class="go">2) &quot;events&quot;</span>
<span class="go">3) (integer) 1</span>
</pre></div>
</div>
<p>Leave this command running, start the Django development server and make
changes in the admin: add, modify, or delete objects. You should see
corresponding events published to the <code class="docutils literal notranslate"><span class="pre">&quot;events&quot;</span></code> stream.</p>
</section>
<section id="broadcast-events">
<h3>Broadcast events<a class="headerlink" href="django.html#broadcast-events" title="Link to this heading">¶</a></h3>
<p>Now let’s turn to reading events and broadcasting them to connected clients.
We need to add several features:</p>
<ul class="simple">
<li><p>Keep track of connected clients so we can broadcast messages.</p></li>
<li><p>Tell which content types the user has permission to view or to change.</p></li>
<li><p>Connect to the message bus and read events.</p></li>
<li><p>Broadcast these events to users who have corresponding permissions.</p></li>
</ul>
<p>Here’s a complete implementation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">aioredis</span>
<span class="kn">import</span> <span class="nn">django</span>

<span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">sesame.utils</span> <span class="kn">import</span> <span class="n">get_user</span>
<span class="kn">from</span> <span class="nn">websockets.asyncio.server</span> <span class="kn">import</span> <span class="n">broadcast</span><span class="p">,</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">websockets.frames</span> <span class="kn">import</span> <span class="n">CloseCode</span>


<span class="n">CONNECTIONS</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">get_content_types</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the set of IDs of content types visible by user.&quot;&quot;&quot;</span>
    <span class="c1"># This does only three database queries because Django caches</span>
    <span class="c1"># all permissions on the first call to user.has_perm(...).</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">ct</span><span class="o">.</span><span class="n">id</span>
        <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">.view_</span><span class="si">{</span><span class="n">ct</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">.change_</span><span class="si">{</span><span class="n">ct</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="p">}</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Authenticate user and register connection in CONNECTIONS.&quot;&quot;&quot;</span>
    <span class="n">sesame</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">get_user</span><span class="p">,</span> <span class="n">sesame</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">CloseCode</span><span class="o">.</span><span class="n">INTERNAL_ERROR</span><span class="p">,</span> <span class="s2">&quot;authentication failed&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">ct_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">get_content_types</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">CONNECTIONS</span><span class="p">[</span><span class="n">websocket</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;content_type_ids&quot;</span><span class="p">:</span> <span class="n">ct_ids</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">CONNECTIONS</span><span class="p">[</span><span class="n">websocket</span><span class="p">]</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">process_events</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Listen to events in Redis and process them.&quot;&quot;&quot;</span>
    <span class="n">redis</span> <span class="o">=</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="s2">&quot;redis://127.0.0.1:6379/1&quot;</span><span class="p">)</span>
    <span class="n">pubsub</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">pubsub</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">pubsub</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">pubsub</span><span class="o">.</span><span class="n">listen</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="c1"># Broadcast event to all users who have permissions to see it.</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="n">recipients</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">websocket</span>
            <span class="k">for</span> <span class="n">websocket</span><span class="p">,</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">CONNECTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;content_type_id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">connection</span><span class="p">[</span><span class="s2">&quot;content_type_ids&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">broadcast</span><span class="p">(</span><span class="n">recipients</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">serve</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">8888</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">process_events</span><span class="p">()</span>  <span class="c1"># runs forever</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>Since the <code class="docutils literal notranslate"><span class="pre">get_content_types()</span></code> function makes a database query, it is
wrapped inside <a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.to_thread" title="(in Python v3.13)"><code class="xref py py-func docutils literal notranslate"><span class="pre">asyncio.to_thread()</span></code></a>. It runs once when each WebSocket
connection is open; then its result is cached for the lifetime of the
connection. Indeed, running it for each message would trigger database queries
for all connected users at the same time, which would hurt the database.</p>
<p>The connection handler merely registers the connection in a global variable,
associated to the list of content types for which events should be sent to
that connection, and waits until the client disconnects.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">process_events()</span></code> function reads events from Redis and broadcasts them
to all connections that should receive them. We don’t care much if a sending a
notification fails — this happens when a connection drops between the moment
we iterate on connections and the moment the corresponding message is sent —
so we start a task with for each message and forget about it. Also, this means
we’re immediately ready to process the next event, even if it takes time to
send a message to a slow client.</p>
<p>Since Redis can publish a message to multiple subscribers, multiple instances
of this server can safely run in parallel.</p>
</section>
</section>
<section id="does-it-scale">
<h2>Does it scale?<a class="headerlink" href="django.html#does-it-scale" title="Link to this heading">¶</a></h2>
<p>In theory, given enough servers, this design can scale to a hundred million
clients, since Redis can handle ten thousand servers and each server can
handle ten thousand clients. In practice, you would need a more scalable
message bus before reaching that scale, due to the volume of messages.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="extensions.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Write an extension</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="autoreload.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Reload on code changes</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2013-2024, Aymeric Augustin and contributors
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="django.html#">Integrate with Django</a><ul>
<li><a class="reference internal" href="django.html#authenticate-connections">Authenticate connections</a><ul>
<li><a class="reference internal" href="django.html#generate-tokens">Generate tokens</a></li>
<li><a class="reference internal" href="django.html#validate-tokens">Validate tokens</a></li>
</ul>
</li>
<li><a class="reference internal" href="django.html#stream-events">Stream events</a><ul>
<li><a class="reference internal" href="django.html#set-up-event-bus">Set up event bus</a></li>
<li><a class="reference internal" href="django.html#publish-events">Publish events</a></li>
<li><a class="reference internal" href="django.html#broadcast-events">Broadcast events</a></li>
</ul>
</li>
<li><a class="reference internal" href="django.html#does-it-scale">Does it scale?</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js%3Fv=03fa008d"></script>
    <script src="../_static/doctools.js%3Fv=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js%3Fv=dc90522c"></script>
    <script src="../_static/scripts/furo.js%3Fv=5fa4622c"></script>
    <script src="../_static/clipboard.min.js%3Fv=a7894cd8"></script>
    <script src="../_static/copybutton.js%3Fv=f281be69"></script>
    <script src="../_static/tabs.js%3Fv=3ee01567"></script>
    </body>
</html>