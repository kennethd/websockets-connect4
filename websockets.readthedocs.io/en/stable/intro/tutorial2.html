<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Part 2 - Route & broadcast" />
<meta property="og:type" content="website" />
<meta property="og:url" content="intro/tutorial2.html" />
<meta property="og:site_name" content="websockets" />
<meta property="og:description" content="In the first part of the tutorial, you opened a WebSocket connection from a browser to a server and exchanged events to play moves. The state of the game was stored in an instance of the Connect4 c..." />
<meta name="description" content="In the first part of the tutorial, you opened a WebSocket connection from a browser to a server and exchanged events to play moves. The state of the game was stored in an instance of the Connect4 c..." />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Part 3 - Deploy to the web" href="tutorial3.html" /><link rel="prev" title="Part 1 - Send &amp; receive" href="tutorial1.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>Part 2 - Route &amp; broadcast - websockets 14.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css%3Fv=a746c00c.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css%3Fv=354aac6f.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css%3Fv=76b2166b.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css%3Fv=4c969af8.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css%3Fv=302659d7.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #306998;
  --color-brand-content: #0b487a;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #ffd43bcc;
  --color-brand-content: #ffd43bd9;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #ffd43bcc;
  --color-brand-content: #ffd43bd9;
  
      }
    }
  }
</style><script async type="text/javascript" src="../../../_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="websockets" /><meta name="readthedocs-version-slug" content="stable" /><meta name="readthedocs-resolver-filename" content="/intro/tutorial2.html" /><meta name="readthedocs-http-status" content="200" /></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="tutorial2.html#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">websockets 14.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/websockets.svg" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Getting started</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Getting started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tutorial1.html">Part 1 - Send &amp; receive</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="tutorial2.html#">Part 2 - Route &amp; broadcast</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial3.html">Part 3 - Deploy to the web</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../howto/index.html">How-to guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of How-to guides</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../howto/quickstart.html">Quick start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/upgrade.html">Upgrade to the new <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code> implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/cheatsheet.html">Cheat sheet</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/patterns.html">Patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/autoreload.html">Reload on code changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/django.html">Integrate with Django</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/extensions.html">Write an extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/render.html">Deploy to Render</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/fly.html">Deploy to Fly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/heroku.html">Deploy to Heroku</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/kubernetes.html">Deploy to Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/supervisor.html">Deploy with Supervisor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/nginx.html">Deploy behind nginx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/haproxy.html">Deploy behind HAProxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/sansio.html">Integrate the Sans-I/O layer</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../faq/index.html">Frequently asked questions</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Frequently asked questions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/server.html">Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/client.html">Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/common.html">Both sides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/asyncio.html">Using asyncio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of API reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/features.html">Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/asyncio/server.html">Server (new <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/asyncio/client.html">Client (new <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sync/server.html">Server (<code class="xref py py-mod docutils literal notranslate"><span class="pre">threading</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sync/client.html">Client (<code class="xref py py-mod docutils literal notranslate"><span class="pre">threading</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sansio/server.html">Server (Sans-I/O)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/sansio/client.html">Client (Sans-I/O)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/legacy/server.html">Server (legacy <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/legacy/client.html">Client (legacy <code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/extensions.html">Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/datastructures.html">Data structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/exceptions.html">Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/types.html">Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/variables.html">Environment variables</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../topics/index.html">Topic guides</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Topic guides</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../topics/deployment.html">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/authentication.html">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/broadcast.html">Broadcasting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/compression.html">Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/keepalive.html">Keepalive and latency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/memory.html">Memory and buffers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../topics/performance.html">Performance</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../project/index.html">About websockets</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of About websockets</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../project/changelog.html">Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/contributing.html">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/sponsoring.html">Sponsoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/tidelift.html">For enterprise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/support.html">Getting support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/license.html">License</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="tutorial2.html#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="part-2-route-broadcast">
<h1>Part 2 - Route &amp; broadcast<a class="headerlink" href="tutorial2.html#part-2-route-broadcast" title="Link to this heading">¶</a></h1>
<div class="admonition-this-is-the-second-part-of-the-tutorial admonition">
<p class="admonition-title">This is the second part of the tutorial.</p>
<ul class="simple">
<li><p>In the <a class="reference internal" href="tutorial1.html"><span class="doc">first part</span></a>, you created a server and
connected one browser; you could play if you shared the same browser.</p></li>
<li><p>In this <a class="reference internal" href="tutorial2.html#"><span class="doc">second part</span></a>, you will connect a second
browser; you can play from different browsers on a local network.</p></li>
<li><p>In the <a class="reference internal" href="tutorial3.html"><span class="doc">third part</span></a>, you will deploy the game to the
web; you can play from any browser connected to the Internet.</p></li>
</ul>
</div>
<p>In the first part of the tutorial, you opened a WebSocket connection from a
browser to a server and exchanged events to play moves. The state of the game
was stored in an instance of the <a class="reference internal" href="tutorial1.html#connect4.Connect4" title="connect4.Connect4"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connect4</span></code></a> class,
referenced as a local variable in the connection handler coroutine.</p>
<p>Now you want to open two WebSocket connections from two separate browsers, one
for each player, to the same server in order to play the same game. This
requires moving the state of the game to a place where both connections can
access it.</p>
<section id="share-game-state">
<h2>Share game state<a class="headerlink" href="tutorial2.html#share-game-state" title="Link to this heading">¶</a></h2>
<p>As long as you’re running a single server process, you can share state by
storing it in a global variable.</p>
<div class="hint admonition">
<p class="admonition-title">What if you need to scale to multiple server processes?</p>
<p>In that case, you must design a way for the process that handles a given
connection to be aware of relevant events for that client. This is often
achieved with a publish / subscribe mechanism.</p>
</div>
<p>How can you make two connection handlers agree on which game they’re playing?
When the first player starts a game, you give it an identifier. Then, you
communicate the identifier to the second player. When the second player joins
the game, you look it up with the identifier.</p>
<p>In addition to the game itself, you need to keep track of the WebSocket
connections of the two players. Since both players receive the same events,
you don’t need to treat the two connections differently; you can store both
in the same set.</p>
<p>Let’s sketch this in code.</p>
<p>A module-level <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">dict</span></code></a> enables lookups by identifier:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">JOIN</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
<p>When the first player starts the game, initialize and store it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">secrets</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="c1"># Initialize a Connect Four game, the set of WebSocket connections</span>
    <span class="c1"># receiving moves from this game, and secret access token.</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">Connect4</span><span class="p">()</span>
    <span class="n">connected</span> <span class="o">=</span> <span class="p">{</span><span class="n">websocket</span><span class="p">}</span>

    <span class="n">join_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">JOIN</span><span class="p">[</span><span class="n">join_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">game</span><span class="p">,</span> <span class="n">connected</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="o">...</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">JOIN</span><span class="p">[</span><span class="n">join_key</span><span class="p">]</span>
</pre></div>
</div>
<p>When the second player joins the game, look it up:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="n">join_key</span> <span class="o">=</span> <span class="o">...</span>

    <span class="c1"># Find the Connect Four game.</span>
    <span class="n">game</span><span class="p">,</span> <span class="n">connected</span> <span class="o">=</span> <span class="n">JOIN</span><span class="p">[</span><span class="n">join_key</span><span class="p">]</span>

    <span class="c1"># Register to receive moves from this game.</span>
    <span class="n">connected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="o">...</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">connected</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice how we’re carefully cleaning up global state with <code class="docutils literal notranslate"><span class="pre">try:</span> <span class="pre">...</span>
<span class="pre">finally:</span> <span class="pre">...</span></code> blocks. Else, we could leave references to games or
connections in global state, which would cause a memory leak.</p>
<p>In both connection handlers, you have a <code class="docutils literal notranslate"><span class="pre">game</span></code> pointing to the same
<a class="reference internal" href="tutorial1.html#connect4.Connect4" title="connect4.Connect4"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connect4</span></code></a> instance, so you can interact with the game,
and a <code class="docutils literal notranslate"><span class="pre">connected</span></code> set of connections, so you can send game events to
both players as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">connected</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>Perhaps you spotted a major piece missing from the puzzle. How does the second
player obtain <code class="docutils literal notranslate"><span class="pre">join_key</span></code>? Let’s design new events to carry this information.</p>
<p>To start a game, the first player sends an <code class="docutils literal notranslate"><span class="pre">&quot;init&quot;</span></code> event:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;init&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>The connection handler for the first player creates a game as shown above and
responds with:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;init&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">join</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&lt;join_key&gt;&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>With this information, the user interface of the first player can create a
link to <code class="docutils literal notranslate"><span class="pre">http://localhost:8000/?join=&lt;join_key&gt;</span></code>. For the sake of simplicity,
we will assume that the first player shares this link with the second player
outside of the application, for example via an instant messaging service.</p>
<p>To join the game, the second player sends a different <code class="docutils literal notranslate"><span class="pre">&quot;init&quot;</span></code> event:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;init&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">join</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&lt;join_key&gt;&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>The connection handler for the second player can look up the game with the
join key as shown above. There is no need to respond.</p>
<p>Let’s dive into the details of implementing this design.</p>
</section>
<section id="start-a-game">
<h2>Start a game<a class="headerlink" href="tutorial2.html#start-a-game" title="Link to this heading">¶</a></h2>
<p>We’ll start with the initialization sequence for the first player.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">main.js</span></code>, define a function to send an initialization event when the
WebSocket connection is established, which triggers an <code class="docutils literal notranslate"><span class="pre">open</span></code> event:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">initGame</span><span class="p">(</span><span class="nx">websocket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">websocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Send an &quot;init&quot; event for the first player.</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;init&quot;</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="nx">websocket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">event</span><span class="p">));</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Update the initialization sequence to call <code class="docutils literal notranslate"><span class="pre">initGame()</span></code>:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;DOMContentLoaded&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Initialize the UI.</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;.board&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">createBoard</span><span class="p">(</span><span class="nx">board</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Open the WebSocket connection and register event handlers.</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">websocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&quot;ws://localhost:8001/&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">initGame</span><span class="p">(</span><span class="nx">websocket</span><span class="p">);</span>
<span class="w">  </span><span class="nx">receiveMoves</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span><span class="w"> </span><span class="nx">websocket</span><span class="p">);</span>
<span class="w">  </span><span class="nx">sendMoves</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span><span class="w"> </span><span class="nx">websocket</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">app.py</span></code>, define a new <code class="docutils literal notranslate"><span class="pre">handler</span></code> coroutine — keep a copy of the
previous one to reuse it later:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">secrets</span>


<span class="n">JOIN</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>
    <span class="c1"># Initialize a Connect Four game, the set of WebSocket connections</span>
    <span class="c1"># receiving moves from this game, and secret access token.</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">Connect4</span><span class="p">()</span>
    <span class="n">connected</span> <span class="o">=</span> <span class="p">{</span><span class="n">websocket</span><span class="p">}</span>

    <span class="n">join_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">JOIN</span><span class="p">[</span><span class="n">join_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">game</span><span class="p">,</span> <span class="n">connected</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Send the secret access token to the browser of the first player,</span>
        <span class="c1"># where it&#39;ll be used for building a &quot;join&quot; link.</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;init&quot;</span><span class="p">,</span>
            <span class="s2">&quot;join&quot;</span><span class="p">:</span> <span class="n">join_key</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

        <span class="c1"># Temporary - for testing.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;first player started game&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">game</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">websocket</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;first player sent&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">JOIN</span><span class="p">[</span><span class="n">join_key</span><span class="p">]</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>
    <span class="c1"># Receive and parse the &quot;init&quot; event from the UI.</span>
    <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;init&quot;</span>

    <span class="c1"># First player starts a new game.</span>
    <span class="k">await</span> <span class="n">start</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
</pre></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">index.html</span></code>, add an <code class="docutils literal notranslate"><span class="pre">&lt;a&gt;</span></code> element to display the link to share with
the other player.</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;actions&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;action join&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">&gt;</span>Join<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="cm">&lt;!-- ... --&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">main.js</span></code>, modify <code class="docutils literal notranslate"><span class="pre">receiveMoves()</span></code> to handle the <code class="docutils literal notranslate"><span class="pre">&quot;init&quot;</span></code> message and
set the target of that link:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;init&quot;</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Create link for inviting the second player.</span>
<span class="w">    </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;.join&quot;</span><span class="p">).</span><span class="nx">href</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;?join=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Restart the WebSocket server and reload <a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a> in the browser.
There’s a link labeled JOIN below the board with a target that looks like
<a class="reference external" href="http://localhost:8000/?join=95ftAaU5DJVP1zvb">http://localhost:8000/?join=95ftAaU5DJVP1zvb</a>.</p>
<p>The server logs say <code class="docutils literal notranslate"><span class="pre">first</span> <span class="pre">player</span> <span class="pre">started</span> <span class="pre">game</span> <span class="pre">...</span></code>. If you click the board,
you see <code class="docutils literal notranslate"><span class="pre">&quot;play&quot;</span></code> events. There is no feedback in the UI, though, because
you haven’t restored the game logic yet.</p>
<p>Before we get there, let’s handle links with a <code class="docutils literal notranslate"><span class="pre">join</span></code> query parameter.</p>
</section>
<section id="join-a-game">
<h2>Join a game<a class="headerlink" href="tutorial2.html#join-a-game" title="Link to this heading">¶</a></h2>
<p>We’ll now update the initialization sequence to account for the second
player.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">main.js</span></code>, update <code class="docutils literal notranslate"><span class="pre">initGame()</span></code> to send the join key in the <code class="docutils literal notranslate"><span class="pre">&quot;init&quot;</span></code>
message when it’s in the URL:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">initGame</span><span class="p">(</span><span class="nx">websocket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">websocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Send an &quot;init&quot; event according to who is connecting.</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URLSearchParams</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;init&quot;</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;join&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Second player joins an existing game.</span>
<span class="w">      </span><span class="nx">event</span><span class="p">.</span><span class="nx">join</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;join&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// First player starts a new game.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">websocket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">event</span><span class="p">));</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">app.py</span></code>, update the <code class="docutils literal notranslate"><span class="pre">handler</span></code> coroutine to look for the join key in
the <code class="docutils literal notranslate"><span class="pre">&quot;init&quot;</span></code> message, then load that game:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">join_key</span><span class="p">):</span>
    <span class="c1"># Find the Connect Four game.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">game</span><span class="p">,</span> <span class="n">connected</span> <span class="o">=</span> <span class="n">JOIN</span><span class="p">[</span><span class="n">join_key</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">error</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="s2">&quot;Game not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Register to receive moves from this game.</span>
    <span class="n">connected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="c1"># Temporary - for testing.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;second player joined game&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">game</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">websocket</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;second player sent&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">connected</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>
    <span class="c1"># Receive and parse the &quot;init&quot; event from the UI.</span>
    <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;init&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;join&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
        <span class="c1"># Second player joins an existing game.</span>
        <span class="k">await</span> <span class="n">join</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;join&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># First player starts a new game.</span>
        <span class="k">await</span> <span class="n">start</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
</pre></div>
</div>
<p>Restart the WebSocket server and reload <a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a> in the browser.</p>
<p>Copy the link labeled JOIN and open it in another browser. You may also open
it in another tab or another window of the same browser; however, that makes
it a bit tricky to remember which one is the first or second player.</p>
<div class="tip admonition">
<p class="admonition-title">You must start a new game when you restart the server.</p>
<p>Since games are stored in the memory of the Python process, they’re lost
when you stop the server.</p>
<p>Whenever you make changes to <code class="docutils literal notranslate"><span class="pre">app.py</span></code>, you must restart the server,
create a new game in a browser, and join it in another browser.</p>
</div>
<p>The server logs say <code class="docutils literal notranslate"><span class="pre">first</span> <span class="pre">player</span> <span class="pre">started</span> <span class="pre">game</span> <span class="pre">...</span></code> and <code class="docutils literal notranslate"><span class="pre">second</span> <span class="pre">player</span>
<span class="pre">joined</span> <span class="pre">game</span> <span class="pre">...</span></code>. The numbers match, proving that the <code class="docutils literal notranslate"><span class="pre">game</span></code> local
variable in both connection handlers points to same object in the memory of
the Python process.</p>
<p>Click the board in either browser. The server receives <code class="docutils literal notranslate"><span class="pre">&quot;play&quot;</span></code> events from
the corresponding player.</p>
<p>In the initialization sequence, you’re routing connections to <code class="docutils literal notranslate"><span class="pre">start()</span></code> or
<code class="docutils literal notranslate"><span class="pre">join()</span></code> depending on the first message received by the server. This is a
common pattern in servers that handle different clients.</p>
<div class="hint admonition">
<p class="admonition-title">Why not use different URIs for <code class="docutils literal notranslate"><span class="pre">start()</span></code> and <code class="docutils literal notranslate"><span class="pre">join()</span></code>?</p>
<p>Instead of sending an initialization event, you could encode the join key
in the WebSocket URI e.g. <code class="docutils literal notranslate"><span class="pre">ws://localhost:8001/join/&lt;join_key&gt;</span></code>. The
WebSocket server would parse <code class="docutils literal notranslate"><span class="pre">websocket.path</span></code> and route the connection,
similar to how HTTP servers route requests.</p>
<p>When you need to send sensitive data like authentication credentials to
the server, sending it an event is considered more secure than encoding
it in the URI because URIs end up in logs.</p>
<p>For the purposes of this tutorial, both approaches are equivalent because
the join key comes from an HTTP URL. There isn’t much at risk anyway!</p>
</div>
<p>Now you can restore the logic for playing moves and you’ll have a fully
functional two-player game.</p>
</section>
<section id="add-the-game-logic">
<h2>Add the game logic<a class="headerlink" href="tutorial2.html#add-the-game-logic" title="Link to this heading">¶</a></h2>
<p>Once the initialization is done, the game is symmetrical, so you can write a
single coroutine to process the moves of both players:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">connected</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>With such a coroutine, you can replace the temporary code for testing in
<code class="docutils literal notranslate"><span class="pre">start()</span></code> by:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">play</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">PLAYER1</span><span class="p">,</span> <span class="n">connected</span><span class="p">)</span>
</pre></div>
</div>
<p>and in <code class="docutils literal notranslate"><span class="pre">join()</span></code> by:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">play</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">PLAYER2</span><span class="p">,</span> <span class="n">connected</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">play()</span></code> coroutine will reuse much of the code you wrote in the first
part of the tutorial.</p>
<p>Try to implement this by yourself!</p>
<p>Keep in mind that you must restart the WebSocket server, reload the page to
start a new game with the first player, copy the JOIN link, and join the game
with the second player when you make changes.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">play()</span></code> works, you can play the game from two separate browsers,
possibly running on separate computers on the same local network.</p>
<p>A complete solution is available at the bottom of this document.</p>
</section>
<section id="watch-a-game">
<h2>Watch a game<a class="headerlink" href="tutorial2.html#watch-a-game" title="Link to this heading">¶</a></h2>
<p>Let’s add one more feature: allow spectators to watch the game.</p>
<p>The process for inviting a spectator can be the same as for inviting the
second player. You will have to duplicate all the initialization logic:</p>
<ul class="simple">
<li><p>declare a <code class="docutils literal notranslate"><span class="pre">WATCH</span></code> global variable similar to <code class="docutils literal notranslate"><span class="pre">JOIN</span></code>;</p></li>
<li><p>generate a watch key when creating a game; it must be different from the
join key, or else a spectator could hijack a game by tweaking the URL;</p></li>
<li><p>include the watch key in the <code class="docutils literal notranslate"><span class="pre">&quot;init&quot;</span></code> event sent to the first player;</p></li>
<li><p>generate a WATCH link in the UI with a <code class="docutils literal notranslate"><span class="pre">watch</span></code> query parameter;</p></li>
<li><p>update the <code class="docutils literal notranslate"><span class="pre">initGame()</span></code> function to handle such links;</p></li>
<li><p>update the <code class="docutils literal notranslate"><span class="pre">handler()</span></code> coroutine to invoke a <code class="docutils literal notranslate"><span class="pre">watch()</span></code> coroutine for
spectators;</p></li>
<li><p>prevent <code class="docutils literal notranslate"><span class="pre">sendMoves()</span></code> from sending <code class="docutils literal notranslate"><span class="pre">&quot;play&quot;</span></code> events for spectators.</p></li>
</ul>
<p>Once the initialization sequence is done, watching a game is as simple as
registering the WebSocket connection in the <code class="docutils literal notranslate"><span class="pre">connected</span></code> set in order to
receive game events and doing nothing until the spectator disconnects. You
can wait for a connection to terminate with
<a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.ServerConnection.wait_closed" title="websockets.asyncio.server.ServerConnection.wait_closed"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_closed()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">watch</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">watch_key</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="n">connected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">connected</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
</pre></div>
</div>
<p>The connection can terminate because the <code class="docutils literal notranslate"><span class="pre">receiveMoves()</span></code> function closed it
explicitly after receiving a <code class="docutils literal notranslate"><span class="pre">&quot;win&quot;</span></code> event, because the spectator closed
their browser, or because the network failed.</p>
<p>Again, try to implement this by yourself.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">watch()</span></code> works, you can invite spectators to watch the game from other
browsers, as long as they’re on the same local network.</p>
<p>As a further improvement, you may support adding spectators while a game is
already in progress. This requires replaying moves that were played before
the spectator was added to the <code class="docutils literal notranslate"><span class="pre">connected</span></code> set. Past moves are available in
the <a class="reference internal" href="tutorial1.html#connect4.Connect4.moves" title="connect4.Connect4.moves"><code class="xref py py-attr docutils literal notranslate"><span class="pre">moves</span></code></a> attribute of the game.</p>
<p>This feature is included in the solution proposed below.</p>
</section>
<section id="broadcast">
<h2>Broadcast<a class="headerlink" href="tutorial2.html#broadcast" title="Link to this heading">¶</a></h2>
<p>When you need to send a message to the two players and to all spectators,
you’re using this pattern:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">connected</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>Since this is a very common pattern in WebSocket servers, websockets provides
the <a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.broadcast" title="websockets.asyncio.server.broadcast"><code class="xref py py-func docutils literal notranslate"><span class="pre">broadcast()</span></code></a> helper for this purpose:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">websockets.asyncio.server</span> <span class="kn">import</span> <span class="n">broadcast</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="n">broadcast</span><span class="p">(</span><span class="n">connected</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>Calling <a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.broadcast" title="websockets.asyncio.server.broadcast"><code class="xref py py-func docutils literal notranslate"><span class="pre">broadcast()</span></code></a> once is more efficient than
calling <a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.ServerConnection.send" title="websockets.asyncio.server.ServerConnection.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> in a loop.</p>
<p>However, there’s a subtle difference in behavior. Did you notice that there’s no
<code class="docutils literal notranslate"><span class="pre">await</span></code> in the second version? Indeed, <a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.broadcast" title="websockets.asyncio.server.broadcast"><code class="xref py py-func docutils literal notranslate"><span class="pre">broadcast()</span></code></a> is a
function, not a coroutine like <a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.ServerConnection.send" title="websockets.asyncio.server.ServerConnection.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> or
<a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.ServerConnection.recv" title="websockets.asyncio.server.ServerConnection.recv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a>.</p>
<p>It’s quite obvious why <a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.ServerConnection.recv" title="websockets.asyncio.server.ServerConnection.recv"><code class="xref py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a>
is a coroutine. When you want to receive the next message, you have to wait
until the client sends it and the network transmits it.</p>
<p>It’s less obvious why <a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.ServerConnection.send" title="websockets.asyncio.server.ServerConnection.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> is
a coroutine. If you send many messages or large messages, you could write
data faster than the network can transmit it or the client can read it. Then,
outgoing data will pile up in buffers, which will consume memory and may
crash your application.</p>
<p>To avoid this problem, <a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.ServerConnection.send" title="websockets.asyncio.server.ServerConnection.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a>
waits until the write buffer drains. By slowing down the application as
necessary, this ensures that the server doesn’t send data too quickly. This
is called backpressure and it’s useful for building robust systems.</p>
<p>That said, when you’re sending the same messages to many clients in a loop,
applying backpressure in this way can become counterproductive. When you’re
broadcasting, you don’t want to slow down everyone to the pace of the slowest
clients; you want to drop clients that cannot keep up with the data stream.
That’s why <a class="reference internal" href="../reference/asyncio/server.html#websockets.asyncio.server.broadcast" title="websockets.asyncio.server.broadcast"><code class="xref py py-func docutils literal notranslate"><span class="pre">broadcast()</span></code></a> doesn’t wait until write buffers
drain and therefore doesn’t need to be a coroutine.</p>
<p>For our Connect Four game, there’s no difference in practice. The total amount
of data sent on a connection for a game of Connect Four is so small that the
write buffer cannot fill up. As a consequence, backpressure never kicks in.</p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="tutorial2.html#summary" title="Link to this heading">¶</a></h2>
<p>In this second part of the tutorial, you learned how to:</p>
<ul class="simple">
<li><p>configure a connection by exchanging initialization messages;</p></li>
<li><p>keep track of connections within a single server process;</p></li>
<li><p>wait until a client disconnects in a connection handler;</p></li>
<li><p>broadcast a message to many connections efficiently.</p></li>
</ul>
<p>You can now play a Connect Four game from separate browser, communicating over
WebSocket connections with a server that synchronizes the game logic!</p>
<p>However, the two players have to be on the same local network as the server,
so the constraint of being in the same place still mostly applies.</p>
<p>Head over to the <a class="reference internal" href="tutorial3.html"><span class="doc">third part</span></a> of the tutorial to deploy the
game to the web and remove this constraint.</p>
</section>
<section id="solution">
<h2>Solution<a class="headerlink" href="tutorial2.html#solution" title="Link to this heading">¶</a></h2>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">app.py</span><a class="headerlink" href="tutorial2.html#id1" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="ch">#!/usr/bin/env python</span>
<span class="linenos">  2</span>
<span class="linenos">  3</span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos">  4</span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos">  5</span><span class="kn">import</span> <span class="nn">secrets</span>
<span class="linenos">  6</span>
<span class="linenos">  7</span><span class="kn">from</span> <span class="nn">websockets.asyncio.server</span> <span class="kn">import</span> <span class="n">broadcast</span><span class="p">,</span> <span class="n">serve</span>
<span class="linenos">  8</span>
<span class="linenos">  9</span><span class="kn">from</span> <span class="nn">connect4</span> <span class="kn">import</span> <span class="n">PLAYER1</span><span class="p">,</span> <span class="n">PLAYER2</span><span class="p">,</span> <span class="n">Connect4</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="n">JOIN</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="n">WATCH</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span>
<span class="linenos"> 17</span><span class="k">async</span> <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="linenos"> 18</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 19</span><span class="sd">    Send an error message.</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 22</span>    <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 23</span>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
<span class="linenos"> 24</span>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
<span class="linenos"> 25</span>    <span class="p">}</span>
<span class="linenos"> 26</span>    <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="k">async</span> <span class="k">def</span> <span class="nf">replay</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">game</span><span class="p">):</span>
<span class="linenos"> 30</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 31</span><span class="sd">    Send previous moves.</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 34</span>    <span class="c1"># Make a copy to avoid an exception if game.moves changes while iteration</span>
<span class="linenos"> 35</span>    <span class="c1"># is in progress. If a move is played while replay is running, moves will</span>
<span class="linenos"> 36</span>    <span class="c1"># be sent out of order but each move will be sent once and eventually the</span>
<span class="linenos"> 37</span>    <span class="c1"># UI will be consistent.</span>
<span class="linenos"> 38</span>    <span class="k">for</span> <span class="n">player</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">game</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
<span class="linenos"> 39</span>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 40</span>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;play&quot;</span><span class="p">,</span>
<span class="linenos"> 41</span>            <span class="s2">&quot;player&quot;</span><span class="p">:</span> <span class="n">player</span><span class="p">,</span>
<span class="linenos"> 42</span>            <span class="s2">&quot;column&quot;</span><span class="p">:</span> <span class="n">column</span><span class="p">,</span>
<span class="linenos"> 43</span>            <span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">,</span>
<span class="linenos"> 44</span>        <span class="p">}</span>
<span class="linenos"> 45</span>        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="k">async</span> <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">connected</span><span class="p">):</span>
<span class="linenos"> 49</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 50</span><span class="sd">    Receive and process moves from a player.</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 53</span>    <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">websocket</span><span class="p">:</span>
<span class="linenos"> 54</span>        <span class="c1"># Parse a &quot;play&quot; event from the UI.</span>
<span class="linenos"> 55</span>        <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="linenos"> 56</span>        <span class="k">assert</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;play&quot;</span>
<span class="linenos"> 57</span>        <span class="n">column</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;column&quot;</span><span class="p">]</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 60</span>            <span class="c1"># Play the move.</span>
<span class="linenos"> 61</span>            <span class="n">row</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">player</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
<span class="linenos"> 62</span>        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="linenos"> 63</span>            <span class="c1"># Send an &quot;error&quot; event if the move was illegal.</span>
<span class="linenos"> 64</span>            <span class="k">await</span> <span class="n">error</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
<span class="linenos"> 65</span>            <span class="k">continue</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span>        <span class="c1"># Send a &quot;play&quot; event to update the UI.</span>
<span class="linenos"> 68</span>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 69</span>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;play&quot;</span><span class="p">,</span>
<span class="linenos"> 70</span>            <span class="s2">&quot;player&quot;</span><span class="p">:</span> <span class="n">player</span><span class="p">,</span>
<span class="linenos"> 71</span>            <span class="s2">&quot;column&quot;</span><span class="p">:</span> <span class="n">column</span><span class="p">,</span>
<span class="linenos"> 72</span>            <span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">,</span>
<span class="linenos"> 73</span>        <span class="p">}</span>
<span class="linenos"> 74</span>        <span class="n">broadcast</span><span class="p">(</span><span class="n">connected</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>        <span class="c1"># If move is winning, send a &quot;win&quot; event.</span>
<span class="linenos"> 77</span>        <span class="k">if</span> <span class="n">game</span><span class="o">.</span><span class="n">winner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 78</span>            <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 79</span>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;win&quot;</span><span class="p">,</span>
<span class="linenos"> 80</span>                <span class="s2">&quot;player&quot;</span><span class="p">:</span> <span class="n">game</span><span class="o">.</span><span class="n">winner</span><span class="p">,</span>
<span class="linenos"> 81</span>            <span class="p">}</span>
<span class="linenos"> 82</span>            <span class="n">broadcast</span><span class="p">(</span><span class="n">connected</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 87</span><span class="sd">    Handle a connection from the first player: start a new game.</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 90</span>    <span class="c1"># Initialize a Connect Four game, the set of WebSocket connections</span>
<span class="linenos"> 91</span>    <span class="c1"># receiving moves from this game, and secret access tokens.</span>
<span class="linenos"> 92</span>    <span class="n">game</span> <span class="o">=</span> <span class="n">Connect4</span><span class="p">()</span>
<span class="linenos"> 93</span>    <span class="n">connected</span> <span class="o">=</span> <span class="p">{</span><span class="n">websocket</span><span class="p">}</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span>    <span class="n">join_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="linenos"> 96</span>    <span class="n">JOIN</span><span class="p">[</span><span class="n">join_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">game</span><span class="p">,</span> <span class="n">connected</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span>    <span class="n">watch_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="linenos"> 99</span>    <span class="n">WATCH</span><span class="p">[</span><span class="n">watch_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">game</span><span class="p">,</span> <span class="n">connected</span>
<span class="linenos">100</span>
<span class="linenos">101</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">102</span>        <span class="c1"># Send the secret access tokens to the browser of the first player,</span>
<span class="linenos">103</span>        <span class="c1"># where they&#39;ll be used for building &quot;join&quot; and &quot;watch&quot; links.</span>
<span class="linenos">104</span>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">105</span>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;init&quot;</span><span class="p">,</span>
<span class="linenos">106</span>            <span class="s2">&quot;join&quot;</span><span class="p">:</span> <span class="n">join_key</span><span class="p">,</span>
<span class="linenos">107</span>            <span class="s2">&quot;watch&quot;</span><span class="p">:</span> <span class="n">watch_key</span><span class="p">,</span>
<span class="linenos">108</span>        <span class="p">}</span>
<span class="linenos">109</span>        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
<span class="linenos">110</span>        <span class="c1"># Receive and process moves from the first player.</span>
<span class="linenos">111</span>        <span class="k">await</span> <span class="n">play</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">PLAYER1</span><span class="p">,</span> <span class="n">connected</span><span class="p">)</span>
<span class="linenos">112</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">113</span>        <span class="k">del</span> <span class="n">JOIN</span><span class="p">[</span><span class="n">join_key</span><span class="p">]</span>
<span class="linenos">114</span>        <span class="k">del</span> <span class="n">WATCH</span><span class="p">[</span><span class="n">watch_key</span><span class="p">]</span>
<span class="linenos">115</span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="k">async</span> <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">join_key</span><span class="p">):</span>
<span class="linenos">118</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">119</span><span class="sd">    Handle a connection from the second player: join an existing game.</span>
<span class="linenos">120</span>
<span class="linenos">121</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">122</span>    <span class="c1"># Find the Connect Four game.</span>
<span class="linenos">123</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">124</span>        <span class="n">game</span><span class="p">,</span> <span class="n">connected</span> <span class="o">=</span> <span class="n">JOIN</span><span class="p">[</span><span class="n">join_key</span><span class="p">]</span>
<span class="linenos">125</span>    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<span class="linenos">126</span>        <span class="k">await</span> <span class="n">error</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="s2">&quot;Game not found.&quot;</span><span class="p">)</span>
<span class="linenos">127</span>        <span class="k">return</span>
<span class="linenos">128</span>
<span class="linenos">129</span>    <span class="c1"># Register to receive moves from this game.</span>
<span class="linenos">130</span>    <span class="n">connected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
<span class="linenos">131</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">132</span>        <span class="c1"># Send the first move, in case the first player already played it.</span>
<span class="linenos">133</span>        <span class="k">await</span> <span class="n">replay</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">game</span><span class="p">)</span>
<span class="linenos">134</span>        <span class="c1"># Receive and process moves from the second player.</span>
<span class="linenos">135</span>        <span class="k">await</span> <span class="n">play</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">PLAYER2</span><span class="p">,</span> <span class="n">connected</span><span class="p">)</span>
<span class="linenos">136</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">137</span>        <span class="n">connected</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
<span class="linenos">138</span>
<span class="linenos">139</span>
<span class="linenos">140</span><span class="k">async</span> <span class="k">def</span> <span class="nf">watch</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">watch_key</span><span class="p">):</span>
<span class="linenos">141</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">142</span><span class="sd">    Handle a connection from a spectator: watch an existing game.</span>
<span class="linenos">143</span>
<span class="linenos">144</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">145</span>    <span class="c1"># Find the Connect Four game.</span>
<span class="linenos">146</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">147</span>        <span class="n">game</span><span class="p">,</span> <span class="n">connected</span> <span class="o">=</span> <span class="n">WATCH</span><span class="p">[</span><span class="n">watch_key</span><span class="p">]</span>
<span class="linenos">148</span>    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<span class="linenos">149</span>        <span class="k">await</span> <span class="n">error</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="s2">&quot;Game not found.&quot;</span><span class="p">)</span>
<span class="linenos">150</span>        <span class="k">return</span>
<span class="linenos">151</span>
<span class="linenos">152</span>    <span class="c1"># Register to receive moves from this game.</span>
<span class="linenos">153</span>    <span class="n">connected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
<span class="linenos">154</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">155</span>        <span class="c1"># Send previous moves, in case the game already started.</span>
<span class="linenos">156</span>        <span class="k">await</span> <span class="n">replay</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">game</span><span class="p">)</span>
<span class="linenos">157</span>        <span class="c1"># Keep the connection open, but don&#39;t receive any messages.</span>
<span class="linenos">158</span>        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>
<span class="linenos">159</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">160</span>        <span class="n">connected</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
<span class="linenos">161</span>
<span class="linenos">162</span>
<span class="linenos">163</span><span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">websocket</span><span class="p">):</span>
<span class="linenos">164</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">165</span><span class="sd">    Handle a connection and dispatch it according to who is connecting.</span>
<span class="linenos">166</span>
<span class="linenos">167</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">168</span>    <span class="c1"># Receive and parse the &quot;init&quot; event from the UI.</span>
<span class="linenos">169</span>    <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<span class="linenos">170</span>    <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="linenos">171</span>    <span class="k">assert</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;init&quot;</span>
<span class="linenos">172</span>
<span class="linenos">173</span>    <span class="k">if</span> <span class="s2">&quot;join&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
<span class="linenos">174</span>        <span class="c1"># Second player joins an existing game.</span>
<span class="linenos">175</span>        <span class="k">await</span> <span class="n">join</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;join&quot;</span><span class="p">])</span>
<span class="linenos">176</span>    <span class="k">elif</span> <span class="s2">&quot;watch&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
<span class="linenos">177</span>        <span class="c1"># Spectator watches an existing game.</span>
<span class="linenos">178</span>        <span class="k">await</span> <span class="n">watch</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;watch&quot;</span><span class="p">])</span>
<span class="linenos">179</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">180</span>        <span class="c1"># First player starts a new game.</span>
<span class="linenos">181</span>        <span class="k">await</span> <span class="n">start</span><span class="p">(</span><span class="n">websocket</span><span class="p">)</span>
<span class="linenos">182</span>
<span class="linenos">183</span>
<span class="linenos">184</span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos">185</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">serve</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">8001</span><span class="p">):</span>
<span class="linenos">186</span>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>  <span class="c1"># run forever</span>
<span class="linenos">187</span>
<span class="linenos">188</span>
<span class="linenos">189</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="linenos">190</span>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">index.html</span><a class="headerlink" href="tutorial2.html#id2" title="Link to this code">¶</a></div>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="linenos"> 2</span><span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="linenos"> 3</span>  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="linenos"> 4</span>    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Connect Four<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="linenos"> 5</span>  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="linenos"> 6</span>  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="linenos"> 7</span>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;actions&quot;</span><span class="p">&gt;</span>
<span class="linenos"> 8</span>      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;action new&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">&gt;</span>New<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="linenos"> 9</span>      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;action join&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">&gt;</span>Join<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="linenos">10</span>      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;action watch&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">&gt;</span>Watch<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="linenos">11</span>    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="linenos">12</span>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;board&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="linenos">13</span>    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;main.js&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;module&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="linenos">14</span>  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="linenos">15</span><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">main.js</span><a class="headerlink" href="tutorial2.html#id3" title="Link to this code">¶</a></div>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createBoard</span><span class="p">,</span><span class="w"> </span><span class="nx">playMove</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./connect4.js&quot;</span><span class="p">;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kd">function</span><span class="w"> </span><span class="nx">initGame</span><span class="p">(</span><span class="nx">websocket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="nx">websocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="c1">// Send an &quot;init&quot; event according to who is connecting.</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URLSearchParams</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;init&quot;</span><span class="w"> </span><span class="p">};</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;join&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 9</span><span class="w">      </span><span class="c1">// Second player joins an existing game.</span>
<span class="linenos">10</span><span class="w">      </span><span class="nx">event</span><span class="p">.</span><span class="nx">join</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;join&quot;</span><span class="p">);</span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;watch&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">12</span><span class="w">      </span><span class="c1">// Spectator watches an existing game.</span>
<span class="linenos">13</span><span class="w">      </span><span class="nx">event</span><span class="p">.</span><span class="nx">watch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;watch&quot;</span><span class="p">);</span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">15</span><span class="w">      </span><span class="c1">// First player starts a new game.</span>
<span class="linenos">16</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">17</span><span class="w">    </span><span class="nx">websocket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">event</span><span class="p">));</span>
<span class="linenos">18</span><span class="w">  </span><span class="p">});</span>
<span class="linenos">19</span><span class="p">}</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="kd">function</span><span class="w"> </span><span class="nx">showMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">22</span><span class="w">  </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">alert</span><span class="p">(</span><span class="nx">message</span><span class="p">),</span><span class="w"> </span><span class="mf">50</span><span class="p">);</span>
<span class="linenos">23</span><span class="p">}</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="kd">function</span><span class="w"> </span><span class="nx">receiveMoves</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span><span class="w"> </span><span class="nx">websocket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">26</span><span class="w">  </span><span class="nx">websocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">27</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="linenos">28</span><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">29</span><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;init&quot;</span><span class="o">:</span>
<span class="linenos">30</span><span class="w">        </span><span class="c1">// Create links for inviting the second player and spectators.</span>
<span class="linenos">31</span><span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;.join&quot;</span><span class="p">).</span><span class="nx">href</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;?join=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;.watch&quot;</span><span class="p">).</span><span class="nx">href</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;?watch=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">watch</span><span class="p">;</span>
<span class="linenos">33</span><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;play&quot;</span><span class="o">:</span>
<span class="linenos">35</span><span class="w">        </span><span class="c1">// Update the UI with the move.</span>
<span class="linenos">36</span><span class="w">        </span><span class="nx">playMove</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">column</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">row</span><span class="p">);</span>
<span class="linenos">37</span><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">38</span><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;win&quot;</span><span class="o">:</span>
<span class="linenos">39</span><span class="w">        </span><span class="nx">showMessage</span><span class="p">(</span><span class="sb">`Player </span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">player</span><span class="si">}</span><span class="sb"> wins!`</span><span class="p">);</span>
<span class="linenos">40</span><span class="w">        </span><span class="c1">// No further messages are expected; close the WebSocket connection.</span>
<span class="linenos">41</span><span class="w">        </span><span class="nx">websocket</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="mf">1000</span><span class="p">);</span>
<span class="linenos">42</span><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">43</span><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;error&quot;</span><span class="o">:</span>
<span class="linenos">44</span><span class="w">        </span><span class="nx">showMessage</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="linenos">45</span><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">46</span><span class="w">      </span><span class="k">default</span><span class="o">:</span>
<span class="linenos">47</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Unsupported event type: </span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">.`</span><span class="p">);</span>
<span class="linenos">48</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">49</span><span class="w">  </span><span class="p">});</span>
<span class="linenos">50</span><span class="p">}</span>
<span class="linenos">51</span>
<span class="linenos">52</span><span class="kd">function</span><span class="w"> </span><span class="nx">sendMoves</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span><span class="w"> </span><span class="nx">websocket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">53</span><span class="w">  </span><span class="c1">// Don&#39;t send moves for a spectator watching a game.</span>
<span class="linenos">54</span><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URLSearchParams</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">);</span>
<span class="linenos">55</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;watch&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">56</span><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">57</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="w">  </span><span class="c1">// When clicking a column, send a &quot;play&quot; event for a move in that column.</span>
<span class="linenos">60</span><span class="w">  </span><span class="nx">board</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">61</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">target</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">column</span><span class="p">;</span>
<span class="linenos">62</span><span class="w">    </span><span class="c1">// Ignore clicks outside a column.</span>
<span class="linenos">63</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">column</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">64</span><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">65</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">66</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">67</span><span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;play&quot;</span><span class="p">,</span>
<span class="linenos">68</span><span class="w">      </span><span class="nx">column</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">column</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">),</span>
<span class="linenos">69</span><span class="w">    </span><span class="p">};</span>
<span class="linenos">70</span><span class="w">    </span><span class="nx">websocket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">event</span><span class="p">));</span>
<span class="linenos">71</span><span class="w">  </span><span class="p">});</span>
<span class="linenos">72</span><span class="p">}</span>
<span class="linenos">73</span>
<span class="linenos">74</span><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;DOMContentLoaded&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">75</span><span class="w">  </span><span class="c1">// Initialize the UI.</span>
<span class="linenos">76</span><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">board</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;.board&quot;</span><span class="p">);</span>
<span class="linenos">77</span><span class="w">  </span><span class="nx">createBoard</span><span class="p">(</span><span class="nx">board</span><span class="p">);</span>
<span class="linenos">78</span><span class="w">  </span><span class="c1">// Open the WebSocket connection and register event handlers.</span>
<span class="linenos">79</span><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">websocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&quot;ws://localhost:8001/&quot;</span><span class="p">);</span>
<span class="linenos">80</span><span class="w">  </span><span class="nx">initGame</span><span class="p">(</span><span class="nx">websocket</span><span class="p">);</span>
<span class="linenos">81</span><span class="w">  </span><span class="nx">receiveMoves</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span><span class="w"> </span><span class="nx">websocket</span><span class="p">);</span>
<span class="linenos">82</span><span class="w">  </span><span class="nx">sendMoves</span><span class="p">(</span><span class="nx">board</span><span class="p">,</span><span class="w"> </span><span class="nx">websocket</span><span class="p">);</span>
<span class="linenos">83</span><span class="p">});</span>
</pre></div>
</div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="tutorial3.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Part 3 - Deploy to the web</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="tutorial1.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Part 1 - Send &amp; receive</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2013-2024, Aymeric Augustin and contributors
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="tutorial2.html#">Part 2 - Route &amp; broadcast</a><ul>
<li><a class="reference internal" href="tutorial2.html#share-game-state">Share game state</a></li>
<li><a class="reference internal" href="tutorial2.html#start-a-game">Start a game</a></li>
<li><a class="reference internal" href="tutorial2.html#join-a-game">Join a game</a></li>
<li><a class="reference internal" href="tutorial2.html#add-the-game-logic">Add the game logic</a></li>
<li><a class="reference internal" href="tutorial2.html#watch-a-game">Watch a game</a></li>
<li><a class="reference internal" href="tutorial2.html#broadcast">Broadcast</a></li>
<li><a class="reference internal" href="tutorial2.html#summary">Summary</a></li>
<li><a class="reference internal" href="tutorial2.html#solution">Solution</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js%3Fv=03fa008d"></script>
    <script src="../_static/doctools.js%3Fv=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js%3Fv=dc90522c"></script>
    <script src="../_static/scripts/furo.js%3Fv=5fa4622c"></script>
    <script src="../_static/clipboard.min.js%3Fv=a7894cd8"></script>
    <script src="../_static/copybutton.js%3Fv=f281be69"></script>
    <script src="../_static/tabs.js%3Fv=3ee01567"></script>
    </body>
</html>